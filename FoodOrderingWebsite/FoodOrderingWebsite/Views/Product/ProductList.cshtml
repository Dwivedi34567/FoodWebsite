@model FoodOrderingWebsite.ViewModel.ProductViewModel;
@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["Title"] = "Product Page";
}

<div>
    <h4 class="sub-title">Product List</h4>
    <div style="width:90%; margin:0 auto;">
        <table id="Product" class="table table-striped table-bordered dt-responsive nowrap" width="100%" cellspacing="0">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Image</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Action/s</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.ProductList != null)
                {
                    @foreach (var product in Model.ProductList)
                    {
                        <tr>
                            <td>@product.ProductName</td>
                            <td>
                                @if (product.ProductImage != null && product.ProductImage.Length > 0)
                                {
                                    string imageBase64 = Convert.ToBase64String(product.ProductImage);
                                    <img src="data:image/jpg;base64,@imageBase64" alt="@product.ProductName" class="category-image" />
                                }
                            </td>
                            <td>@product.ProductCategory</td>
                            <td>@product.ProductPrice</td>
                            <td>
                                <a href="@Url.Action("EditProduct", "Product", new { productId = product.ProductId })"><i class="bi bi-pencil-square text-primary"></i></a>
                                <a href="@Url.Action("DeleteProduct", "Product", new { productId = product.ProductId })" class="delete"><i class="bi bi-trash text-danger"></i></a>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Delete Popup modal -->
<div class="modal fade" id="deleteProductModal" tabindex="-1" role="dialog" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteProductModalLabel">Delete Product</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteProduct">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Success modal -->
<div class="modal fade" id="deleteSuccessModal" tabindex="-1" role="dialog" aria-labelledby="deleteSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteSuccessModalLabel">Delete Success</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Product deleted successfully.</p>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('#Product').DataTable({
            "pagingType": "simple",
            "pageLength": 4
        });

        // Event listener for the delete button
        $('.delete').click(function (event) {
            event.preventDefault();

            // Get the productId from the anchor tag's href attribute
            var productId = $(this).attr('href').split('=')[1];

            // Display the Bootstrap confirmation modal
            $('#deleteProductModal').modal('show').data('productId', productId);
        });

        // Event listener for the confirmation button inside the modal
        $('#confirmDeleteProduct').click(function () {
            var productId = $('#deleteProductModal').data('productId');

            $.ajax({
                url: '/Product/DeleteProduct',
                type: 'DELETE',
                data: { productId: productId },
                success: function (response) {
                    if (response.success) {
                        $('#deleteProductModal').modal('hide');
                        $('#deleteSuccessModal').modal('show');
                        setTimeout(function () {
                            $('#deleteSuccessModal').modal('hide');
                            location.reload();
                        }, 2000);
                    } else {
                        alert("Failed to delete product!");
                    }
                },
                error: function (xhr, status, error) {
                    alert("AJAX error: " + status + "\nError: " + error);
                }
            });
        });
    });
</script>